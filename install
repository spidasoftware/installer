#!/bin/bash
OS=`cat /etc/issue`
VERSION=$(egrep -o "[0-9]{1,}\.[0-9]{1,}" <<< "$OS")

### First get Docker
### ---------------------------------------

#### Ubuntu Section
if [[ $OS == *"Ubuntu"* ]]; then
  echo "Ubuntu $VERSION"
  if(( $(bc <<< "$VERSION < 14.0") == 1 )); then
    echo "$VERSION is not a supported Ubuntu Version, need > 14.04"
    exit -1
  else
    sudo apt-get update
    sudo apt-get -y install docker.io
    source /etc/bash_completion.d/docker.io 
  fi

#### RHEL Section
elif [[ $OS == *"Red Hat Enterprise Linux Server"* ]]; then
  echo "RHEL $VERSION"
  sudo yum update

  if(( $(bc <<< "$VERSION < 6.5") == 1 )); then
    echo "$VERSION is not a supported RHEL Version, need > 6.5"
    exit -1
  elif(( $(bc <<< "$VERSION > 6.99") == 1 )); then
    # 7.0 plus
    sudo subscription-manager repos --enable=rhel-7-server-extras-rpms
    sudo yum -y install docker
  else
    # 6.5 but less than 7 
    sudo yum -y remove docker
    sudo yum -y install docker-io
    sudo yum -y update docker-io
  fi

  #Start the service
  sudo service docker start
  sudo chkconfig docker on

#### SUSE Section - Check this on a SUSE system
# elif [[ $OS == *"SUSE"* ]]; then
  # if(( $(bc <<< "$VERSION == 12.3") == 1 )); then
  #   sudo zypper ar -f http://download.opensuse.org/repositories/Virtualization/openSUSE_12.3/ Virtualization
  # elif(( $(bc <<< "$VERSION == 13.1") == 1 )); then
  #   sudo zypper ar -f http://download.opensuse.org/repositories/Virtualization/openSUSE_13.1/ Virtualization
  # elif(( $(bc <<< "$VERSION < 13") == 1 )); then
  #   echo "$VERSION is not a supported SUSE Version, need 12.3 or 13.1"
  #   exit -1
  # fi
  # sudo zypper in docker
  # sudo systemctl start docker
  # sudo systemctl enable docker

else
  echo "$OS is not a supported OS"
  exit -1
fi

### Then get the actual images/build we need.
### ---------------------------------------

# Read if there were any parameters in the commandline, if not, pull the default "SPIDAMin installation"
echo "Pulling SPIDAMin and its dependencies."

## DO ALL THE DOCKER STUFF
#docker pull spidasoftware/min-automated:latest
docker pull spidasoftware/redis:latest
#docker pull spidasoftware/mongodb:latest
#docker pull spidasoftware/postgresql:latest

sudo docker run --restart=always spidasoftware/redis:latest
